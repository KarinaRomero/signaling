/**
 * @license
 * Created by Karina Romero on 26/06/2016.
 * Copyright Â© 2016 Sandcode Software S.A. de C.V. All rights reserved.
 */
function sendTo(e,n){e.send(JSON.stringify(n))}var users={},WebsocketServer=require("ws").Server,wss=new WebsocketServer({port:8888});wss.on("connection",function(e){console.log("User Conected"),e.on("message",function(n){var o;try{o=JSON.parse(n),console.log(o)}catch(e){console.log("Error parse JSON"),o={}}switch(o.type){case"login":console.log("User logged in as ",o.name),users[o.name]?sendTo(e,{type:"login",success:!1}):(users[o.name]=e,e.name=o.name,sendTo(e,{type:"login",success:!0}));break;case"offer":console.log("Send offer to",o.name);var s=users[o.name];null!=s&&(e.otherName=o.name,sendTo(s,{type:"offer",offer:o.offer,name:e.name}));break;case"answer":console.log("sending answer to: ",o.name);var s=users[o.name];null!=s&&(e.otherName=o.name,sendTo(s,{type:"answer",answer:o.answer}));break;case"candidate":console.log("Sending candidate to ",o.name);var s=users[o.name];null!=s&&sendTo(s,{type:"candidate",candidate:o.candidate});break;case"leave":console.log("Disconnecting user from",o.name);var s=users[o.name];s.otherName=null,null!=s&&sendTo(s,{type:"leave"});break;default:sendTo(e,{type:"error",message:"Unrecognized command: "+o.type})}}),e.send("Hello world"),e.on("close",function(){if(e.name&&(delete users[e.name],e.otherName)){console.log("Disconnecting user from ",e.otherName);var n=users[e.otherName];n.otherName=null,null!=n&&sendTo(n,{type:"leave"})}})}),wss.on("listening",function(){console.log("server started...")});